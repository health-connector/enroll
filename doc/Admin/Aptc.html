<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Admin::Aptc
  
    &mdash; Documentation by YARD 0.9.12
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Admin::Aptc";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (A)</a> &raquo;
    <span class='title'>Admin</span>
     &raquo; 
    <span class="title">Aptc</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Admin::Aptc
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">ApplicationController</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ApplicationController</li>
          
            <li class="next">Admin::Aptc</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd>Mongoid::Document, Mongoid::Timestamps, <span class='object_link'><a href="../SetCurrentUser.html" title="SetCurrentUser (module)">SetCurrentUser</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/models/admin/aptc.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_aptc_applied_per_member_values_for_enrollment-class_method" title="build_aptc_applied_per_member_values_for_enrollment (class method)">.<strong>build_aptc_applied_per_member_values_for_enrollment</strong>(family, current_hbx, aptc_applied_vals, applied_aptc_array = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_aptc_applied_values_for_enrollment-class_method" title="build_aptc_applied_values_for_enrollment (class method)">.<strong>build_aptc_applied_values_for_enrollment</strong>(year, family, current_hbx, applied_aptc_array = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_aptc_per_enrollment-class_method" title="build_aptc_per_enrollment (class method)">.<strong>build_aptc_per_enrollment</strong>(hbxs)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_avalaible_aptc_values-class_method" title="build_avalaible_aptc_values (class method)">.<strong>build_avalaible_aptc_values</strong>(year, family, hbxs, applied_aptc_array = nil, max_aptc = nil, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_csr_percentage_values-class_method" title="build_csr_percentage_values (class method)">.<strong>build_csr_percentage_values</strong>(year, family, csr_percentage = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_current_aptc_applied_hash-class_method" title="build_current_aptc_applied_hash (class method)">.<strong>build_current_aptc_applied_hash</strong>(hbxs, applied_aptcs_array = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_eligible_members-class_method" title="build_eligible_members (class method)">.<strong>build_eligible_members</strong>(family, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_enrollment_level_aptc_csr_data-class_method" title="build_enrollment_level_aptc_csr_data (class method)">.<strong>build_enrollment_level_aptc_csr_data</strong>(year, family, hbx, applied_aptc_array = nil, max_aptc = nil, csr_percentage = nil, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>TODO: Last param remove.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_enrollments_data-class_method" title="build_enrollments_data (class method)">.<strong>build_enrollments_data</strong>(year, family, hbxs, applied_aptc_array = nil, max_aptc = nil, csr_percentage = nil, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_error_messages-class_method" title="build_error_messages (class method)">.<strong>build_error_messages</strong>(max_aptc, csr_percentage, applied_aptcs_array, year, hbxs)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_household_level_aptc_csr_data-class_method" title="build_household_level_aptc_csr_data (class method)">.<strong>build_household_level_aptc_csr_data</strong>(year, family, hbxs = nil, max_aptc = nil, csr_percentage = nil, applied_aptc_array = nil, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_household_members-class_method" title="build_household_members (class method)">.<strong>build_household_members</strong>(year, family, max_aptc = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>def negative_aptc(k, a_value, b_value,
total_aptc_applied_vals_for_household, hbxs)   a_value - b_value end.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_max_aptc_values-class_method" title="build_max_aptc_values (class method)">.<strong>build_max_aptc_values</strong>(year, family, max_aptc = nil, hbxs = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_plan_premium_hash_for_enrollments-class_method" title="build_plan_premium_hash_for_enrollments (class method)">.<strong>build_plan_premium_hash_for_enrollments</strong>(hbxs)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#calculate_slcsp_value-class_method" title="calculate_slcsp_value (class method)">.<strong>calculate_slcsp_value</strong>(year, family, member_ids = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#find_enrollment_effective_on_date-class_method" title="find_enrollment_effective_on_date (class method)">.<strong>find_enrollment_effective_on_date</strong>(hbx_created_datetime)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>15th of the month rule.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#last_of_month_converter-class_method" title="last_of_month_converter (class method)">.<strong>last_of_month_converter</strong>(month, year = TimeKeeper.date_of_record.year)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#max_aptc_that_can_be_applied_for_this_enrollment-class_method" title="max_aptc_that_can_be_applied_for_this_enrollment (class method)">.<strong>max_aptc_that_can_be_applied_for_this_enrollment</strong>(hbx_id, max_aptc_for_household)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#redetermine_eligibility_with_updated_values-class_method" title="redetermine_eligibility_with_updated_values (class method)">.<strong>redetermine_eligibility_with_updated_values</strong>(family, params, hbxs, year)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Redetermine Eligibility on Max APTC / CSR Update.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_aptc_applied_for_enrollments-class_method" title="update_aptc_applied_for_enrollments (class method)">.<strong>update_aptc_applied_for_enrollments</strong>(family, params, year)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create new Enrollments when Applied APTC for an Enrollment is Updated.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_aptc_applied_hash_for_month-class_method" title="update_aptc_applied_hash_for_month (class method)">.<strong>update_aptc_applied_hash_for_month</strong>(year, aptc_applied_hash, current_hbx, month, hbx_iter, family, applied_aptc_array = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_csr_percentages_hash_for_month-class_method" title="update_csr_percentages_hash_for_month (class method)">.<strong>update_csr_percentages_hash_for_month</strong>(csr_percentage_hash, year, month, ed, csr_percentage = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_max_aptc_hash_for_month-class_method" title="update_max_aptc_hash_for_month (class method)">.<strong>update_max_aptc_hash_for_month</strong>(max_aptc_hash, year, month, ed, max_aptc = nil, hbxs = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#years_with_tax_household-class_method" title="years_with_tax_household (class method)">.<strong>years_with_tax_household</strong>(family)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../SetCurrentUser.html" title="SetCurrentUser (module)">SetCurrentUser</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../SetCurrentUser.html#included-class_method" title="SetCurrentUser.included (method)">included</a></span>, <span class='object_link'><a href="../SetCurrentUser.html#save_user-instance_method" title="SetCurrentUser#save_user (method)">#save_user</a></span>, <span class='object_link'><a href="../SetCurrentUser.html#update_user-instance_method" title="SetCurrentUser#update_user (method)">#update_user</a></span></p>

  
  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="build_aptc_applied_per_member_values_for_enrollment-class_method">
  
    .<strong>build_aptc_applied_per_member_values_for_enrollment</strong>(family, current_hbx, aptc_applied_vals, applied_aptc_array = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 106</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_aptc_applied_per_member_values_for_enrollment'>build_aptc_applied_per_member_values_for_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_aptc_applied_vals'>aptc_applied_vals</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_aptc_applied_per_member'>aptc_applied_per_member</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_percent_sum'>percent_sum</span> <span class='op'>=</span> <span class='float'>0.0</span>
  <span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span>

  <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_member'>member</span><span class='op'>|</span>
    <span class='id identifier rubyid_percent_sum'>percent_sum</span> <span class='op'>+=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_applicant_id'>applicant_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='float'>0.0</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hem'>hem</span><span class='op'>|</span>
    <span class='id identifier rubyid_ratio_for_this_member'>ratio_for_this_member</span> <span class='op'>=</span> <span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_applicant_id'>applicant_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_aptc_applied_member_vals'>aptc_applied_member_vals</span> <span class='op'>=</span> <span class='id identifier rubyid_aptc_applied_vals'>aptc_applied_vals</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='op'>|</span> <span class='id identifier rubyid_h'>h</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>*</span> <span class='id identifier rubyid_ratio_for_this_member'>ratio_for_this_member</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>/</span> <span class='id identifier rubyid_percent_sum'>percent_sum</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span><span class='semicolon'>;</span> <span class='id identifier rubyid_h'>h</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_aptc_applied_per_member'>aptc_applied_per_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span>  <span class='id identifier rubyid_aptc_applied_member_vals'>aptc_applied_member_vals</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_aptc_applied_per_member'>aptc_applied_per_member</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_aptc_applied_values_for_enrollment-class_method">
  
    .<strong>build_aptc_applied_values_for_enrollment</strong>(year, family, current_hbx, applied_aptc_array = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


68
69
70
71
72
73
74
75
76
77
78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 68</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_aptc_applied_values_for_enrollment'>build_aptc_applied_values_for_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Get all aptc enrollments (coverage selected, terminated or cancelled) that have the same hbx_id as current_hbx.
</span>  <span class='comment'># These are the dups of the current enrollment that were saved when APTC values were updated.
</span>  <span class='id identifier rubyid_enrollments_with_same_hbx_id'>enrollments_with_same_hbx_id</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollments_with_aptc_by_year'>hbx_enrollments_with_aptc_by_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_by_hbx_id'>by_hbx_id</span><span class='lparen'>(</span><span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_id'>hbx_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_enrollments_with_same_hbx_id'>enrollments_with_same_hbx_id</span><span class='period'>.</span><span class='id identifier rubyid_sort!'>sort!</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='gvar'>$months_array</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ind'>ind</span><span class='op'>|</span>
    <span class='id identifier rubyid_enrollments_with_same_hbx_id'>enrollments_with_same_hbx_id</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='op'>|</span>
      <span class='id identifier rubyid_update_aptc_applied_hash_for_month'>update_aptc_applied_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_aptc_per_enrollment-class_method">
  
    .<strong>build_aptc_per_enrollment</strong>(hbxs)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246
247
248
249
250
251
252</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 244</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_aptc_per_enrollment'>build_aptc_per_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_aptc_per_enrollment'>aptc_per_enrollment</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
    <span class='id identifier rubyid_plan_name'>plan_name</span>         <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Plan.html" title="Plan (class)">Plan</a></span></span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>id:</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_plan_id'>plan_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
    <span class='id identifier rubyid_hbx_applied_aptc'>hbx_applied_aptc</span>  <span class='op'>=</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='id identifier rubyid_aptc_per_enrollment'>aptc_per_enrollment</span><span class='lbracket'>[</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_hbx_applied_aptc'>hbx_applied_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_plan_name'>plan_name</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_aptc_per_enrollment'>aptc_per_enrollment</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_avalaible_aptc_values-class_method">
  
    .<strong>build_avalaible_aptc_values</strong>(year, family, hbxs, applied_aptc_array = nil, max_aptc = nil, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


18
19
20
21
22
23
24
25
26
27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 18</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_avalaible_aptc_values'>build_avalaible_aptc_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span>  <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_available_aptc_hash'>available_aptc_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='comment'>#max_aptc_vals             = build_max_aptc_values(family, max_aptc)
</span>  <span class='id identifier rubyid_max_aptc_vals'>max_aptc_vals</span>             <span class='op'>=</span> <span class='id identifier rubyid_build_max_aptc_values'>build_max_aptc_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_total_aptc_applied_vals_for_household'>total_aptc_applied_vals_for_household</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='lbracket'>[</span><span class='gvar'>$months_array</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_x'>x</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='float'>0.0</span><span class='rbracket'>]</span> <span class='rbrace'>}</span><span class='rbracket'>]</span> <span class='comment'># Initialize a Hash for monthly values.
</span>  <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
    <span class='id identifier rubyid_aptc_applied_vals_for_enrollment'>aptc_applied_vals_for_enrollment</span> <span class='op'>=</span> <span class='id identifier rubyid_build_aptc_applied_values_for_enrollment'>build_aptc_applied_values_for_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_total_aptc_applied_vals_for_household'>total_aptc_applied_vals_for_household</span>  <span class='op'>=</span> <span class='id identifier rubyid_total_aptc_applied_vals_for_household'>total_aptc_applied_vals_for_household</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_aptc_applied_vals_for_enrollment'>aptc_applied_vals_for_enrollment</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_a_value'>a_value</span><span class='comma'>,</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='op'>|</span> <span class='id identifier rubyid_a_value'>a_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>+</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='rbrace'>}</span> <span class='comment'># Adding values of two similar hashes.
</span>  <span class='kw'>end</span>
  <span class='comment'>#subtract each value of aptc_applied hash from the max_aptc hash to get APTC Available.
</span>  <span class='id identifier rubyid_max_aptc_vals'>max_aptc_vals</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_total_aptc_applied_vals_for_household'>total_aptc_applied_vals_for_household</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_a_value'>a_value</span><span class='comma'>,</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_a_value'>a_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>?</span> <span class='lparen'>(</span><span class='id identifier rubyid_a_value'>a_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>-</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='id identifier rubyid_a_value'>a_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>-</span> <span class='id identifier rubyid_b_value'>b_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_csr_percentage_values-class_method">
  
    .<strong>build_csr_percentage_values</strong>(year, family, csr_percentage = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


165
166
167
168
169
170
171
172
173
174
175
176
177</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 165</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_csr_percentage_values'>build_csr_percentage_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='comment'>#eligibility_determinations = family.active_household.latest_active_tax_household.eligibility_determinations
</span>  <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_eligibility_determinations_for_year'>eligibility_determinations_for_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span><span class='period'>.</span><span class='id identifier rubyid_sort!'>sort!</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span><span class='rbrace'>}</span>
  <span class='comment'>#ed = family.active_household.latest_tax_household_with_year(year).latest_eligibility_determination
</span>  <span class='gvar'>$months_array</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ind'>ind</span><span class='op'>|</span>
    <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ed'>ed</span><span class='op'>|</span>
      <span class='id identifier rubyid_update_csr_percentages_hash_for_month'>update_csr_percentages_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ed'>ed</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_current_aptc_applied_hash-class_method">
  
    .<strong>build_current_aptc_applied_hash</strong>(hbxs, applied_aptcs_array = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


255
256
257
258
259
260
261
262
263
264
265
266
267</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 255</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_current_aptc_applied_hash'>build_current_aptc_applied_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_hbxs'>hbxs</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_current_aptc_applied_hash'>current_aptc_applied_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
      <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_app_aptc'>app_aptc</span><span class='op'>|</span>
        <span class='id identifier rubyid_current_aptc_applied_hash'>current_aptc_applied_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span>  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_app_aptc'>app_aptc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='kw'>if</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='id identifier rubyid_app_aptc'>app_aptc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hbx_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_current_aptc_applied_hash'>current_aptc_applied_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span> <span class='op'>||</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_current_aptc_applied_hash'>current_aptc_applied_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_eligible_members-class_method">
  
    .<strong>build_eligible_members</strong>(family, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


230
231
232
233
234
235
236
237
238
239
240
241</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 230</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_eligible_members'>build_eligible_members</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_member_ids'>member_ids</span> <span class='kw'>if</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
  <span class='id identifier rubyid_eligible_members'>eligible_members</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_tax_household_members'>tax_household_members</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'><span class='object_link'><a href="../TimeKeeper.html#date_of_record-class_method" title="TimeKeeper.date_of_record (method)">date_of_record</a></span></span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:tax_household_members</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_tax_household_members'>tax_household_members</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_tax_household_members'>tax_household_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_member'>member</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_is_ia_eligible'>is_ia_eligible</span>
      <span class='id identifier rubyid_eligible_members'>eligible_members</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_eligible_members'>eligible_members</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_enrollment_level_aptc_csr_data-class_method">
  
    .<strong>build_enrollment_level_aptc_csr_data</strong>(year, family, hbx, applied_aptc_array = nil, max_aptc = nil, csr_percentage = nil, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>TODO: Last param remove</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


53
54
55
56
57</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 53</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_enrollment_level_aptc_csr_data'>build_enrollment_level_aptc_csr_data</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span>  <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='comment'>#TODO: Last param remove
</span>  <span class='id identifier rubyid_aptc_applied_vals'>aptc_applied_vals</span>             <span class='op'>=</span> <span class='id identifier rubyid_build_aptc_applied_values_for_enrollment'>build_aptc_applied_values_for_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_aptc_applied_per_member_vals'>aptc_applied_per_member_vals</span>  <span class='op'>=</span> <span class='id identifier rubyid_build_aptc_applied_per_member_values_for_enrollment'>build_aptc_applied_per_member_values_for_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_aptc_applied_vals'>aptc_applied_vals</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_aptc_applied_vals'>aptc_applied_vals</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_per_member</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_aptc_applied_per_member_vals'>aptc_applied_per_member_vals</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_enrollments_data-class_method">
  
    .<strong>build_enrollments_data</strong>(year, family, hbxs, applied_aptc_array = nil, max_aptc = nil, csr_percentage = nil, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_enrollments_data'>build_enrollments_data</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_enrollments_data'>enrollments_data</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
    <span class='id identifier rubyid_enrollments_data'>enrollments_data</span><span class='lbracket'>[</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_build_enrollment_level_aptc_csr_data'>build_enrollment_level_aptc_csr_data</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_enrollments_data'>enrollments_data</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_error_messages-class_method">
  
    .<strong>build_error_messages</strong>(max_aptc, csr_percentage, applied_aptcs_array, year, hbxs)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 397</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_error_messages'>build_error_messages</span><span class='lparen'>(</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sum_of_all_applied'>sum_of_all_applied</span> <span class='op'>=</span> <span class='float'>0.0</span>
  <span class='id identifier rubyid_aptc_errors'>aptc_errors</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span> <span class='op'>!=</span> <span class='id identifier rubyid_year'>year</span>
    <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>EFFECTIVE_DATE_OVERFLOW</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_effective_date_overflow'>effective_date_overflow</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
      <span class='id identifier rubyid_max_for_hbx'>max_for_hbx</span> <span class='op'>=</span> <span class='id identifier rubyid_max_aptc_that_can_be_applied_for_this_enrollment'>max_aptc_that_can_be_applied_for_this_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_hbx'>hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hbx_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
      <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ENROLLMENT_MAX_SMALLER_THAN_APPLIED</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_enrollment_max_smaller_than_applied'>enrollment_max_smaller_than_applied</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[NEW_MAX_FOR_ENROLLMENT (</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_max_for_hbx'>max_for_hbx</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'>) &lt; APPLIED_APTC (</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_applied_aptc'>applied_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'>)] </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_for_hbx'>max_for_hbx</span>
      <span class='id identifier rubyid_hbx_enrollment'>hbx_enrollment</span> <span class='op'>=</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_h'>h</span><span class='op'>|</span> <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hbx_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='id identifier rubyid_plan_premium'>plan_premium</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_enrollment'>hbx_enrollment</span><span class='period'>.</span><span class='id identifier rubyid_total_premium'>total_premium</span>
      <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PREMIUM_SMALLER_THAN_APPLIED</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_plan_premium_smaller_than_applied'>plan_premium_smaller_than_applied</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[PLAN_PREMIUM (</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_plan_premium'>plan_premium</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'>) &lt; APPLIED_APTC (</span><span class='embexpr_beg'>#{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_applied_aptc'>applied_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'>)] </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_plan_premium'>plan_premium</span>
      <span class='id identifier rubyid_sum_of_all_applied'>sum_of_all_applied</span> <span class='op'>+=</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='comment'>#applied_aptcs_array.each {|hbx|  if applied_aptcs_array.present?
</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>NaN</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MAX_APTC_NON_NUMERIC</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc_non_numeric'>max_aptc_non_numeric</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_applied_aptcs_array'>applied_aptcs_array</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_sum_of_all_applied'>sum_of_all_applied</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MAX_APTC_TOO_SMALL</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc_too_small'>max_aptc_too_small</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&gt;</span> <span class='float'>9999.99</span>
    <span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MAX_APTC_TOO_BIG</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aptc_errors'>aptc_errors</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc_too_big'>max_aptc_too_big</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_aptc_errors'>aptc_errors</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_household_level_aptc_csr_data-class_method">
  
    .<strong>build_household_level_aptc_csr_data</strong>(year, family, hbxs = nil, max_aptc = nil, csr_percentage = nil, applied_aptc_array = nil, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


11
12
13
14
15
16</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 11</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_household_level_aptc_csr_data'>build_household_level_aptc_csr_data</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span>  <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_max_aptc_vals'>max_aptc_vals</span>             <span class='op'>=</span> <span class='id identifier rubyid_build_max_aptc_values'>build_max_aptc_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_csr_percentage_vals'>csr_percentage_vals</span>       <span class='op'>=</span> <span class='id identifier rubyid_build_csr_percentage_values'>build_csr_percentage_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_avalaible_aptc_vals'>avalaible_aptc_vals</span>       <span class='op'>=</span> <span class='id identifier rubyid_build_avalaible_aptc_values'>build_avalaible_aptc_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max_aptc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_max_aptc_vals'>max_aptc_vals</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>available_aptc</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_avalaible_aptc_vals'>avalaible_aptc_vals</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>csr_percentage</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_csr_percentage_vals'>csr_percentage_vals</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_household_members-class_method">
  
    .<strong>build_household_members</strong>(year, family, max_aptc = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>def negative_aptc(k, a_value, b_value,
total_aptc_applied_vals_for_household, hbxs)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_a_value'>a_value</span> <span class='op'>-</span> <span class='id identifier rubyid_b_value'>b_value</span>
</code></pre>

<p>end</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37
38
39
40
41
42
43</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_household_members'>build_household_members</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_individuals_covered_array'>individuals_covered_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>:</span> <span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='kw'>rescue</span> <span class='int'>0</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ratio_by_member'>ratio_by_member</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:aptc_ratio_by_member</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_family_members'>family_members</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_one_member'>one_member</span><span class='comma'>,</span> <span class='id identifier rubyid_index'>index</span><span class='op'>|</span>
    <span class='id identifier rubyid_individuals_covered_array'>individuals_covered_array</span> <span class='op'>&lt;&lt;</span> <span class='lbrace'>{</span><span class='id identifier rubyid_one_member'>one_member</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ratio_by_member'>ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_one_member'>one_member</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>*</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='rbracket'>]</span><span class='rbrace'>}</span>  <span class='kw'>rescue</span> <span class='kw'>nil</span> <span class='comment'># Individuals and their assigned APTC Ratio
</span>  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_individuals_covered_array'>individuals_covered_array</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_max_aptc_values-class_method">
  
    .<strong>build_max_aptc_values</strong>(year, family, max_aptc = nil, hbxs = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 124</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_max_aptc_values'>build_max_aptc_values</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='comment'>#eligibility_determinations = family.active_household.latest_active_tax_household.eligibility_determinations
</span>  <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_eligibility_determinations_for_year'>eligibility_determinations_for_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span><span class='period'>.</span><span class='id identifier rubyid_sort!'>sort!</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='op'>|</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span> <span class='op'>&lt;=&gt;</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span><span class='rbrace'>}</span>
  <span class='comment'>#ed = family.active_household.latest_tax_household_with_year(year).latest_eligibility_determination
</span>  <span class='gvar'>$months_array</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ind'>ind</span><span class='op'>|</span>
    <span class='comment'># iterate over all the EligibilityDeterminations and store the correct max_aptc value for each month. Account for any monthly change in Eligibility Determination.
</span>    <span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_ed'>ed</span><span class='op'>|</span>
      <span class='id identifier rubyid_update_max_aptc_hash_for_month'>update_max_aptc_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ed'>ed</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
      <span class='comment'>#if month == &quot;Jul&quot; || month == &quot;Aug&quot; || month == &quot;Sep&quot;
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_plan_premium_hash_for_enrollments-class_method">
  
    .<strong>build_plan_premium_hash_for_enrollments</strong>(hbxs)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61
62
63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_plan_premium_hash_for_enrollments'>build_plan_premium_hash_for_enrollments</span><span class='lparen'>(</span><span class='id identifier rubyid_hbxs'>hbxs</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_plan_premium_hash'>plan_premium_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hbx'>hbx</span><span class='op'>|</span>
    <span class='id identifier rubyid_plan_premium_hash'>plan_premium_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:total_premium</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_plan_premium_hash'>plan_premium_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="calculate_slcsp_value-class_method">
  
    .<strong>calculate_slcsp_value</strong>(year, family, member_ids = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 212</span>

<span class='kw'>def</span> <span class='id identifier rubyid_calculate_slcsp_value'>calculate_slcsp_value</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_benefit_sponsorship'>benefit_sponsorship</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxProfile.html" title="HbxProfile (class)">HbxProfile</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_hbx'><span class='object_link'><a href="../HbxProfile.html#current_hbx-class_method" title="HbxProfile.current_hbx (method)">current_hbx</a></span></span><span class='period'>.</span><span class='id identifier rubyid_benefit_sponsorship'>benefit_sponsorship</span>
  <span class='comment'>#eligibility_determinations = family.active_household.latest_active_tax_household.eligibility_determinations
</span>  <span class='comment'>#date = Date.new(year, 1, 1)
</span>  <span class='id identifier rubyid_benefit_coverage_period'>benefit_coverage_period</span> <span class='op'>=</span> <span class='id identifier rubyid_benefit_sponsorship'>benefit_sponsorship</span><span class='period'>.</span><span class='id identifier rubyid_benefit_coverage_periods'>benefit_coverage_periods</span><span class='period'>.</span><span class='id identifier rubyid_detect'>detect</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_bcp'>bcp</span><span class='op'>|</span> <span class='id identifier rubyid_bcp'>bcp</span><span class='period'>.</span><span class='id identifier rubyid_contains?'>contains?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='rparen'>)</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_slcsp'>slcsp</span> <span class='op'>=</span> <span class='id identifier rubyid_benefit_coverage_period'>benefit_coverage_period</span><span class='period'>.</span><span class='id identifier rubyid_second_lowest_cost_silver_plan'>second_lowest_cost_silver_plan</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_aptc_members'>aptc_members</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_tax_household_members'>tax_household_members</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_m'>m</span><span class='op'>|</span> <span class='id identifier rubyid_member_ids'>member_ids</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_m'>m</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_aptc_members'>aptc_members</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_members'>aptc_members</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_cost'>cost</span> <span class='op'>=</span> <span class='id identifier rubyid_aptc_members'>aptc_members</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_member'>member</span><span class='op'>|</span>
    <span class='id identifier rubyid_slcsp'>slcsp</span><span class='period'>.</span><span class='id identifier rubyid_premium_for'>premium_for</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_age_on_effective_date'>age_on_effective_date</span><span class='rparen'>)</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_inject'>inject</span><span class='lparen'>(</span><span class='symbol'>:+</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='int'>0</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_cost'>cost</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="find_enrollment_effective_on_date-class_method">
  
    .<strong>find_enrollment_effective_on_date</strong>(hbx_created_datetime)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>15th of the month rule</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 379</span>

<span class='kw'>def</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_offset_month'>offset_month</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span> <span class='op'>&lt;=</span> <span class='int'>15</span> <span class='op'>?</span> <span class='int'>1</span> <span class='op'>:</span> <span class='int'>2</span>
  <span class='id identifier rubyid_year'>year</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span>
  <span class='id identifier rubyid_month'>month</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span> <span class='op'>+</span> <span class='id identifier rubyid_offset_month'>offset_month</span>
  <span class='comment'># Based on the 15th of the month rule, if the effective date happpens to be after the policy&#39;s life (next year),
</span>  <span class='comment'># raise an error and do not create a new EligibilityDetermination (when there is an active enrollment) and/or HbxEnrollment (Eg: After Nov 15th)
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_month'>month</span> <span class='op'>&gt;</span> <span class='int'>12</span>
    <span class='id identifier rubyid_year'>year</span> <span class='op'>=</span> <span class='id identifier rubyid_year'>year</span> <span class='op'>+</span> <span class='int'>1</span>
    <span class='id identifier rubyid_month'>month</span> <span class='op'>=</span> <span class='id identifier rubyid_month'>month</span> <span class='op'>-</span> <span class='int'>12</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_day'>day</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='id identifier rubyid_hour'>hour</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_hour'>hour</span>
  <span class='id identifier rubyid_min'>min</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='id identifier rubyid_sec'>sec</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_created_datetime'>hbx_created_datetime</span><span class='period'>.</span><span class='id identifier rubyid_sec'>sec</span>
  <span class='kw'>return</span> <span class='const'>DateTime</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_day'>day</span><span class='comma'>,</span> <span class='id identifier rubyid_hour'>hour</span><span class='comma'>,</span> <span class='id identifier rubyid_min'>min</span><span class='comma'>,</span> <span class='id identifier rubyid_sec'>sec</span><span class='rparen'>)</span>
  <span class='comment'>#return DateTime.new(year, month, day)
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="last_of_month_converter-class_method">
  
    .<strong>last_of_month_converter</strong>(month, year = TimeKeeper.date_of_record.year)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


204
205
206
207
208
209</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 204</span>

<span class='kw'>def</span> <span class='id identifier rubyid_last_of_month_converter'>last_of_month_converter</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='op'>=</span><span class='const'>TimeKeeper</span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'>date_of_record</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_month_num'>month_num</span> <span class='op'>=</span> <span class='const'>Date</span><span class='op'>::</span><span class='const'>ABBR_MONTHNAMES</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='period'>.</span><span class='id identifier rubyid_capitalize'>capitalize</span> <span class='op'>||</span> <span class='id identifier rubyid_month'>month</span><span class='rparen'>)</span> <span class='comment'># coverts Month name to Month Integer : &quot;jan&quot; -&gt; 1
</span>  <span class='id identifier rubyid_last_day'>last_day</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_days_in_month'>days_in_month</span><span class='lparen'>(</span><span class='id identifier rubyid_month_num'>month_num</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_last_of_month_date'>last_of_month_date</span> <span class='op'>=</span> <span class='const'>Date</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_year'>year</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_month_num'>month_num</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_last_day'>last_day</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_last_of_month_date'>last_of_month_date</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="max_aptc_that_can_be_applied_for_this_enrollment-class_method">
  
    .<strong>max_aptc_that_can_be_applied_for_this_enrollment</strong>(hbx_id, max_aptc_for_household)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 427</span>

<span class='kw'>def</span> <span class='id identifier rubyid_max_aptc_that_can_be_applied_for_this_enrollment'>max_aptc_that_can_be_applied_for_this_enrollment</span><span class='lparen'>(</span><span class='id identifier rubyid_hbx_id'>hbx_id</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc_for_household'>max_aptc_for_household</span><span class='rparen'>)</span>
  <span class='comment'>#1 Get all members in the enrollment
</span>  <span class='comment'>#2 Get APTC ratio for each of these members
</span>  <span class='comment'>#3 Max APTC for Enrollment =&gt; Sum all (ratio * max_aptc) for each members
</span>  <span class='id identifier rubyid_max_aptc_for_enrollment'>max_aptc_for_enrollment</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_hbx'>hbx</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxEnrollment.html" title="HbxEnrollment (class)">HbxEnrollment</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'><span class='object_link'><a href="../HbxEnrollment.html#find-class_method" title="HbxEnrollment.find (method)">find</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_hbx_id'>hbx_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span>
  <span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx'>hbx</span><span class='period'>.</span><span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span>
  <span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hem'>hem</span><span class='op'>|</span>
    <span class='id identifier rubyid_max_aptc_for_enrollment'>max_aptc_for_enrollment</span> <span class='op'>+=</span> <span class='lparen'>(</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_applicant_id'>applicant_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>*</span> <span class='id identifier rubyid_max_aptc_for_household'>max_aptc_for_household</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_max_aptc_for_enrollment'>max_aptc_for_enrollment</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_max_aptc_for_household'>max_aptc_for_household</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='id identifier rubyid_max_aptc_for_household'>max_aptc_for_household</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_max_aptc_for_enrollment'>max_aptc_for_enrollment</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="redetermine_eligibility_with_updated_values-class_method">
  
    .<strong>redetermine_eligibility_with_updated_values</strong>(family, params, hbxs, year)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Redetermine Eligibility on Max APTC / CSR Update.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 270</span>

<span class='kw'>def</span> <span class='id identifier rubyid_redetermine_eligibility_with_updated_values'>redetermine_eligibility_with_updated_values</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_eligibility_redetermination_result'>eligibility_redetermination_result</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span>
  <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span>
  <span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span> <span class='op'>=</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span>
  <span class='id identifier rubyid_csr_percentage_param'>csr_percentage_param</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:csr_percentage</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>limited</span><span class='tstring_end'>&quot;</span></span> <span class='op'>?</span> <span class='op'>-</span><span class='int'>1</span> <span class='op'>:</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:csr_percentage</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='comment'># storing &quot;limited&quot; CSR as -1
</span>
  <span class='kw'>if</span> <span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:max_aptc</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>==</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_csr_percentage_param'>csr_percentage_param</span> <span class='op'>==</span> <span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span><span class='rparen'>)</span> <span class='comment'># If any changes made to MAX APTC or CSR
</span>    <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span> <span class='op'>&gt;</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'><span class='object_link'><a href="../TimeKeeper.html#date_of_record-class_method" title="TimeKeeper.date_of_record (method)">date_of_record</a></span></span>
      <span class='id identifier rubyid_eligibility_date'>eligibility_date</span> <span class='op'>=</span> <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_eligibility_date'>eligibility_date</span> <span class='op'>=</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='rparen'>)</span> <span class='op'>:</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span> <span class='comment'># Follow 15th of month rule if active enrollment.
</span>    <span class='kw'>end</span>
    <span class='comment'># If max_aptc / csr percent is updated, create a new eligibility_determination with a new &quot;determined_at&quot; timestamp and the corresponsing csr/aptc update.
</span>    <span class='id identifier rubyid_tax_household'>tax_household</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_tax_household'>tax_household</span><span class='period'>.</span><span class='id identifier rubyid_eligibility_determinations'>eligibility_determinations</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>determined_at</span><span class='tstring_end'>&quot;</span></span>                 <span class='op'>=&gt;</span> <span class='id identifier rubyid_eligibility_date'>eligibility_date</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>determined_on</span><span class='tstring_end'>&quot;</span></span>                 <span class='op'>=&gt;</span> <span class='id identifier rubyid_eligibility_date'>eligibility_date</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>csr_eligibility_kind</span><span class='tstring_end'>&quot;</span></span>          <span class='op'>=&gt;</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_csr_eligibility_kind'>csr_eligibility_kind</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>premium_credit_strategy_kind</span><span class='tstring_end'>&quot;</span></span>  <span class='op'>=&gt;</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_premium_credit_strategy_kind'>premium_credit_strategy_kind</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>csr_percent_as_integer</span><span class='tstring_end'>&quot;</span></span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_csr_percentage_param'>csr_percentage_param</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>max_aptc</span><span class='tstring_end'>&quot;</span></span>                      <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:max_aptc</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>benchmark_plan_id</span><span class='tstring_end'>&quot;</span></span>             <span class='op'>=&gt;</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_benchmark_plan_id'>benchmark_plan_id</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>e_pdc_id</span><span class='tstring_end'>&quot;</span></span>                      <span class='op'>=&gt;</span> <span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_e_pdc_id'>e_pdc_id</span><span class='comma'>,</span>
                                                    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>source</span><span class='tstring_end'>&quot;</span></span>                        <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Admin</span><span class='tstring_end'>&quot;</span></span>
                                                   <span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
    <span class='id identifier rubyid_eligibility_redetermination_result'>eligibility_redetermination_result</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_eligibility_redetermination_result'>eligibility_redetermination_result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_aptc_applied_for_enrollments-class_method">
  
    .<strong>update_aptc_applied_for_enrollments</strong>(family, params, year)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Create new Enrollments when Applied APTC for an Enrollment is Updated.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 302</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_aptc_applied_for_enrollments'>update_aptc_applied_for_enrollments</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_current_datetime'>current_datetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span>
  <span class='id identifier rubyid_enrollment_update_result'>enrollment_update_result</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='comment'># For every HbxEnrollment, if Applied APTC was updated, clone a new enrtollment with the new Applied APTC and make the current one inactive.
</span>  <span class='comment'>#family = Family.find(params[:person][:family_id])
</span>  <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household_with_year'>latest_active_tax_household_with_year</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_latest_eligibility_determination'>latest_eligibility_determination</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='id identifier rubyid_active_aptc_hbxs'>active_aptc_hbxs</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollments_with_aptc_by_year'>hbx_enrollments_with_aptc_by_year</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:year</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_aptc_value'>aptc_value</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='comment'># TODO enrollment duplication has to be refactored once Ram promotes reusable module to create HbxEnrollment copy
</span>      <span class='id identifier rubyid_hbx_id'>hbx_id</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span><span class='period'>.</span><span class='id identifier rubyid_sub'>sub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_updated_aptc_value'>updated_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_aptc_value'>aptc_value</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
      <span class='id identifier rubyid_actual_aptc_value'>actual_aptc_value</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxEnrollment.html" title="HbxEnrollment (class)">HbxEnrollment</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'><span class='object_link'><a href="../HbxEnrollment.html#find-class_method" title="HbxEnrollment.find (method)">find</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_hbx_id'>hbx_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
      <span class='comment'># Only create enrollments if the APTC values were updated.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_actual_aptc_value'>actual_aptc_value</span> <span class='op'>!=</span> <span class='id identifier rubyid_updated_aptc_value'>updated_aptc_value</span> <span class='comment'># TODO: check if the effective_on doesnt go to next year?????
</span>        <span class='id identifier rubyid_percent_sum_for_all_enrolles'>percent_sum_for_all_enrolles</span> <span class='op'>=</span> <span class='float'>0.0</span>
        <span class='id identifier rubyid_enrollment_update_result'>enrollment_update_result</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='id identifier rubyid_original_hbx'>original_hbx</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxEnrollment.html" title="HbxEnrollment (class)">HbxEnrollment</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'><span class='object_link'><a href="../HbxEnrollment.html#find-class_method" title="HbxEnrollment.find (method)">find</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_hbx_id'>hbx_id</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span>

        <span class='comment'># Duplicate Enrollment
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span> <span class='op'>=</span> <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>

        <span class='comment'># Update the following fields
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span> <span class='op'>=</span> <span class='id identifier rubyid_current_datetime'>current_datetime</span>
        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span> <span class='op'>=</span> <span class='id identifier rubyid_current_datetime'>current_datetime</span>
        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span> <span class='op'>=</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='id identifier rubyid_current_datetime'>current_datetime</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span> <span class='comment'># Populate the effective_on date based on the 15th day rule.
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_id'>hbx_id</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxIdGenerator.html" title="HbxIdGenerator (class)">HbxIdGenerator</a></span></span><span class='period'>.</span><span class='id identifier rubyid_generate_policy_id'><span class='object_link'><a href="../HbxIdGenerator.html#generate_policy_id-class_method" title="HbxIdGenerator.generate_policy_id (method)">generate_policy_id</a></span></span>

        <span class='comment'># Duplicate all Enrollment Members
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span> <span class='op'>=</span> <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_collect'>collect</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_hem'>hem</span><span class='op'>|</span> <span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span><span class='rbrace'>}</span>
        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_hem'>hem</span><span class='op'>|</span> <span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span> <span class='op'>=</span> <span class='id identifier rubyid_current_datetime'>current_datetime</span><span class='rbrace'>}</span>

        <span class='comment'># Update Applied APTC on the enrolllment level.
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_aptc_value'>updated_aptc_value</span>

        <span class='comment'># Update elected_aptc_pct to the correct value based on the new applied_amount
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_elected_aptc_pct'>elected_aptc_pct</span> <span class='op'>=</span> <span class='id identifier rubyid_actual_aptc_value'>actual_aptc_value</span><span class='op'>/</span><span class='id identifier rubyid_max_aptc'>max_aptc</span>

        <span class='comment'># Reset aasm_state
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_aasm_state'>aasm_state</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>shopping</span><span class='tstring_end'>&quot;</span></span>

        <span class='comment'># This (and the division using percent_sum_for_all_enrolles in the next block) is needed to get the right ratio for members to use in an enrollment. (ratio of the applied_aptc for an enrollment)
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_member'>member</span><span class='op'>|</span>
          <span class='id identifier rubyid_percent_sum_for_all_enrolles'>percent_sum_for_all_enrolles</span> <span class='op'>+=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_latest_active_tax_household'>latest_active_tax_household</span><span class='period'>.</span><span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_member'>member</span><span class='period'>.</span><span class='id identifier rubyid_applicant_id'>applicant_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='float'>0.0</span>
        <span class='kw'>end</span>

        <span class='comment'># Update the correct breakdown of Applied APTC on the individual level.
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollment_members'>hbx_enrollment_members</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hem'>hem</span><span class='op'>|</span>
          <span class='id identifier rubyid_aptc_pct_for_member'>aptc_pct_for_member</span> <span class='op'>=</span> <span class='id identifier rubyid_aptc_ratio_by_member'>aptc_ratio_by_member</span><span class='lbracket'>[</span><span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_applicant_id'>applicant_id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='float'>0.0</span>
          <span class='id identifier rubyid_hem'>hem</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_updated_aptc_value'>updated_aptc_value</span> <span class='op'>*</span> <span class='id identifier rubyid_aptc_pct_for_member'>aptc_pct_for_member</span> <span class='op'>/</span> <span class='id identifier rubyid_percent_sum_for_all_enrolles'>percent_sum_for_all_enrolles</span>
        <span class='kw'>end</span>

        <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_hbx_enrollments'>hbx_enrollments</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span>
        <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>

        <span class='comment'># Reload and Select Coverage for new Enrollment. This ensures workflow transition is set
</span>        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_reload'>reload</span>
        <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_select_coverage!'>select_coverage!</span>


        <span class='comment'># Cancel or Terminate Coverage.
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_may_terminate_coverage?'>may_terminate_coverage?</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_terminate_coverage!'>terminate_coverage!</span>
          <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_update_current'>update_current</span><span class='lparen'>(</span><span class='label'>terminated_on:</span> <span class='id identifier rubyid_duplicate_hbx'>duplicate_hbx</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span> <span class='op'>-</span> <span class='int'>1</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_cancel_coverage!'>cancel_coverage!</span> <span class='kw'>if</span> <span class='id identifier rubyid_original_hbx'>original_hbx</span><span class='period'>.</span><span class='id identifier rubyid_may_cancel_coverage?'>may_cancel_coverage?</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_enrollment_update_result'>enrollment_update_result</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_aptc_applied_hash_for_month-class_method">
  
    .<strong>update_aptc_applied_hash_for_month</strong>(year, aptc_applied_hash, current_hbx, month, hbx_iter, family, applied_aptc_array = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 82</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_aptc_applied_hash_for_month'>update_aptc_applied_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='comma'>,</span> <span class='id identifier rubyid_family'>family</span><span class='comma'>,</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>=</span> <span class='id identifier rubyid_last_of_month_converter'>last_of_month_converter</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>=</span> <span class='float'>0.0</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='comment'>#if first_of_month_num_current_year &gt;= TimeKeeper.datetime_of_record
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span> <span class='comment'># Following the 15 day rule for calculations
</span>      <span class='id identifier rubyid_applied_aptc_array'>applied_aptc_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_one_hbx'>one_hbx</span><span class='op'>|</span>
        <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_one_hbx'>one_hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='kw'>if</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='id identifier rubyid_one_hbx'>one_hbx</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hbx_id</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aptc_applied_</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_applied_aptc'>applied_aptc</span> <span class='op'>=</span> <span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='period'>.</span><span class='id identifier rubyid_applied_aptc_amount'>applied_aptc_amount</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>=</span> <span class='id identifier rubyid_last_of_month_converter'>last_of_month_converter</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_hbx_iter'>hbx_iter</span><span class='period'>.</span><span class='id identifier rubyid_effective_on'>effective_on</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span>
    <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_applied_aptc'>applied_aptc</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='float'>0.00</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_aptc_applied_hash'>aptc_applied_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_month'>month</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='comment'>#dont mess with the past values
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_csr_percentages_hash_for_month-class_method">
  
    .<strong>update_csr_percentages_hash_for_month</strong>(csr_percentage_hash, year, month, ed, csr_percentage = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 179</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_csr_percentages_hash_for_month'>update_csr_percentages_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ed'>ed</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>=</span> <span class='id identifier rubyid_last_of_month_converter'>last_of_month_converter</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_csr_percentage_value'>csr_percentage_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'>#csr_percentage_value = csr_percentage.present? ? csr_percentage : ed.csr_percent_as_integer
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='comment'># this is when we check available aptc. We only want to update the current and future fields with the updated value.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span>
      <span class='id identifier rubyid_csr_percentage_value'>csr_percentage_value</span> <span class='op'>=</span> <span class='id identifier rubyid_csr_percentage'>csr_percentage</span>
    <span class='kw'>else</span>
      <span class='comment'># leave past values as-is
</span>      <span class='id identifier rubyid_csr_percentage_value'>csr_percentage_value</span> <span class='op'>=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_csr_percentage_value'>csr_percentage_value</span> <span class='op'>=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span> <span class='op'>==</span> <span class='op'>-</span><span class='int'>1</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>limited</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_csr_percent_as_integer'>csr_percent_as_integer</span>
  <span class='kw'>end</span>
  <span class='comment'># Check if  &#39;month&#39; &gt;= EligibilityDetermination.determined_at date?
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span>
    <span class='comment'># assign that month with csr_percent value from this ed (EligibilityDetermination)
</span>    <span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_csr_percentage_value'>csr_percentage_value</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'># update csr_percent value for that month as a &quot;-&quot;
</span>    <span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_csr_percentage_hash'>csr_percentage_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_month'>month</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update_max_aptc_hash_for_month-class_method">
  
    .<strong>update_max_aptc_hash_for_month</strong>(max_aptc_hash, year, month, ed, max_aptc = nil, hbxs = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 140</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update_max_aptc_hash_for_month'>update_max_aptc_hash_for_month</span><span class='lparen'>(</span><span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='comma'>,</span> <span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_ed'>ed</span><span class='comma'>,</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='op'>=</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>=</span> <span class='id identifier rubyid_last_of_month_converter'>last_of_month_converter</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>if</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span> <span class='op'>=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_tax_household'>tax_household</span><span class='period'>.</span><span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span> <span class='op'>&gt;</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'><span class='object_link'><a href="../TimeKeeper.html#date_of_record-class_method" title="TimeKeeper.date_of_record (method)">date_of_record</a></span></span>
      <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span> <span class='op'>?</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>:</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>  <span class='kw'>if</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_effective_starting_on'>effective_starting_on</span> <span class='op'>?</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>:</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>  <span class='kw'>if</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='comment'># Incase there are active enrollments, follow 15th of the month rule.
</span>    <span class='kw'>else</span>
      <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span> <span class='op'>?</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>:</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>  <span class='kw'>if</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_find_enrollment_effective_on_date'>find_enrollment_effective_on_date</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_datetime_of_record'><span class='object_link'><a href="../TimeKeeper.html#datetime_of_record-class_method" title="TimeKeeper.datetime_of_record (method)">datetime_of_record</a></span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span> <span class='op'>?</span> <span class='id identifier rubyid_max_aptc'>max_aptc</span> <span class='op'>:</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>  <span class='kw'>if</span> <span class='id identifier rubyid_hbxs'>hbxs</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='comment'># Incase there are active enrollments, follow 15th of the month rule.
</span>    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span> <span class='op'>=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_max_aptc'>max_aptc</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='kw'>end</span>
  <span class='comment'># Check if  &#39;month&#39; &gt;= EligibilityDetermination.determined_at date?
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_first_of_month_num_current_year'>first_of_month_num_current_year</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_ed'>ed</span><span class='period'>.</span><span class='id identifier rubyid_determined_at'>determined_at</span><span class='period'>.</span><span class='id identifier rubyid_to_date'>to_date</span>
    <span class='comment'># assign that month with aptc_max value from this ed (EligibilityDetermination)
</span>    <span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_max_aptc_value'>max_aptc_value</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'># update max_aptc value for that month as a &quot;---&quot;
</span>    <span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%.2f</span><span class='tstring_end'>&#39;</span></span> <span class='op'>%</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_max_aptc_hash'>max_aptc_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_month'>month</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="years_with_tax_household-class_method">
  
    .<strong>years_with_tax_household</strong>(family)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


445
446
447
448
449
450
451
452
453
454
455
456</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/admin/aptc.rb', line 445</span>

<span class='kw'>def</span> <span class='id identifier rubyid_years_with_tax_household'>years_with_tax_household</span><span class='lparen'>(</span><span class='id identifier rubyid_family'>family</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_year_set'>year_set</span> <span class='op'>=</span> <span class='id identifier rubyid_family'>family</span><span class='period'>.</span><span class='id identifier rubyid_active_household'>active_household</span><span class='period'>.</span><span class='id identifier rubyid_tax_households'>tax_households</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:effective_starting_on</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:year</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_current_hbx'>current_hbx</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../HbxProfile.html" title="HbxProfile (class)">HbxProfile</a></span></span><span class='period'>.</span><span class='id identifier rubyid_current_hbx'><span class='object_link'><a href="../HbxProfile.html#current_hbx-class_method" title="HbxProfile.current_hbx (method)">current_hbx</a></span></span>
  <span class='id identifier rubyid_oe_start_year'>oe_start_year</span> <span class='op'>=</span> <span class='const'>Settings</span><span class='period'>.</span><span class='id identifier rubyid_aca'>aca</span><span class='period'>.</span><span class='id identifier rubyid_individual_market'>individual_market</span><span class='period'>.</span><span class='id identifier rubyid_open_enrollment'>open_enrollment</span><span class='period'>.</span><span class='id identifier rubyid_start_on'>start_on</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span>
  <span class='id identifier rubyid_current_year'>current_year</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'><span class='object_link'><a href="../TimeKeeper.html#date_of_record-class_method" title="TimeKeeper.date_of_record (method)">date_of_record</a></span></span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_current_hbx'>current_hbx</span><span class='period'>.</span><span class='id identifier rubyid_under_open_enrollment?'>under_open_enrollment?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_oe_start_year'>oe_start_year</span> <span class='op'>==</span> <span class='id identifier rubyid_current_year'>current_year</span>
    <span class='id identifier rubyid_year_set'>year_set</span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../TimeKeeper.html" title="TimeKeeper (class)">TimeKeeper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_date_of_record'><span class='object_link'><a href="../TimeKeeper.html#date_of_record-class_method" title="TimeKeeper.date_of_record (method)">date_of_record</a></span></span><span class='period'>.</span><span class='id identifier rubyid_next_year'>next_year</span><span class='period'>.</span><span class='id identifier rubyid_year'>year</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_year_set'>year_set</span><span class='period'>.</span><span class='id identifier rubyid_uniq'>uniq</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Oct 11 09:49:41 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.12 (ruby-2.2.3).
</div>

    </div>
  </body>
</html>